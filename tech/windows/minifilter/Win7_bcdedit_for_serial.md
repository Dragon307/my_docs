
使用 bcdedit 开启 Windows 7 的内核调试模式
--------------------------------------------------

# 前言

因为 `Windows 7` 的 `bcdedit` 跟其他版本有一点小改动，所以其他系统的方法不一定完全通用。
具体的区别，可以通过 `bcdedit /?` 和 `bcdedit -help xxxxx` 两个命令查询相应的命令格式。
例如：`bcdedit -help copy`。此外，用 `bcdedit /enum` 可以枚举当前的 `bcd` 启动配置信息，建议修改前先浏览一遍，以便有个大致的了解。

**重要**

下面的命令一定要在以 `管理员身份` 启动的命令行里执行，可以在 `Windows 7` 的
 “`开始菜单`” 按钮上点鼠标右键，然后点击 “`命令行（超级管理员）`” 菜单项。目前发现使用 `Windows PowerShell` 命令行执行 `bcdedit` 可能会报错，此时可以手动打开 “`C:\Windows\System32`” 目录下面的 `cmd.exe`，并且以管理员身份运行，最好同时把这个链接发送到 “`桌面`”，这样就不用每次都进到这个文件夹才能运行 `cmd.exe` 了。

## 一、设置新的启动项

### 1. 复制当前启动项 

先复制一份当前的启动配置：

    bcdedit /copy {current} /d "Windows 7 Debug With Serial"

会显示如下信息：

    已将该项成功复制到 {9f5cb028-144c-11e7-aa76-d7a47d59ad30} 。

我们把 “`{9f5cb028-144c-11e7-aa76-d7a47d59ad30}`” 称为 `启动Id` ，该值是随机生成的，每台机器每次执行 `copy` 命令得到的 `GUID` 都是不一样的，所以执行第 `2` 步的时候，不能直接复制教程写的 `GUID`，而是要改为 `copy` 命令返回的结果里的 `GUID` 。

`启动Id` 可以是 `GUID` 值，同时也可以是下列值：`{current}`, `{default}` 等等。

其中 `{current}` 表示当前的启动项，`{default}` 表示你设置的默认启动项（下次启动后生效），
而各个启动项对应的`{guid}` 值可以通过 `bcdedit /enum` 命令来查看。

### 2. 设置默认启动项

我们把刚才 `copy` 命令的得到的启动项 `{9f5cb028-144c-11e7-aa76-d7a47d59ad30}` （该值是每次随机生成的）设置为 `{default}` (默认启动项), 
这样的话后面需要指定 `启动Id` 的地方，使用 `{default}` 代替即可，而不必使用 `GUID` ，简便很多。

命令如下：

    bcdedit /default {前面copy命令返回的GUID值}

把我们刚才添加的 "`Windows 7 Debug With Serial`" 设置为默认启动项。

例如：

    bcdedit /default {9f5cb028-144c-11e7-aa76-d7a47d59ad30}



注意：这里设置的 `GUID` 每台机器上都是不一样的，是随机生成的，具体的值要根据前面 `copy` 命令执行后返回的结果而得到，请改成相应的 `GUID` 。

**关于顺序**

（注：步骤 3、5、6、7 无先后顺序，步骤 4 可以忽略，但 `步骤 8` 必须在步骤 3、5、6、7 执行之后，重启系统，并确认登陆的是我们配置的 `Windows 7 Debug With Serial` 启动项以后才能执行。）

### 3. 启用内核调试模式

命令如下：

    bcdedit /debug {default} ON

注：这里的`{default}` 等价于 `{9f5cb028-144c-11e7-aa76-d7a47d59ad30}`，就是我们之前 `copy` 时看到的 `id` 。

### 4. 设置调试的模式及参数 (此步可忽略和跳过)

调试的模式是 `串口`，端口是`COM1`，速率是 `115200`，命令如下：

    bcdedit /dbgsettings {default} SERIAL DEBUGPORT:1 BAUDRATE:115200

执行上面的命令你将会看得下列错误:

    按规定调试程序类型无效。
    运行 "bcdedit /?" 获得命令行帮助。
    参数错误。

这是由于 `Windows 7` 的 `/dbgsettings` 命令不支持 `{id}` 参数，以前的某些 `Windows` 版本是支持的，但现在不行了。

所以，这一步可以跳过，待第5、6、7步骤完成以后，重启系统后，再执行 `步骤 8`（需先完成第5、6、7步骤）。

### 5. 设置允许测试驱动签名

即不强制检测是否为微软正规的驱动签名：

    bcdedit /set {default} testsigning On

### 6. 关闭强制检测驱动数字签名

命令如下：

    bcdedit /set {default} loadoptions DDISABLE_INTEGRITY_CHECKS
    bcdedit /set {default} nointegritychecks on

当然，这个步骤也可以在开机按 `F8`，进入 “`高级启动选项`”，再选择 “`禁用强制驱动程序签名`” 来实现，但不推荐那么做，用上面的命令即可。

### 7. 设置开机菜单等待时间

命令如下：

    bcdedit /timeout 5

设置开机菜单的等待时间为 `5` 秒，这里不需要指定 `{default}` 或别的 `启动Id`，因为这是全局设置，即所有启动项的等待时间都是统一的。

### 8. 设置串口调试和参数

设置完以上的内容后，重启系统，并选择 “`Windows 7 Debug With Serial`” 启动项，再执行下面的命令：

    bcdedit /dbgsettings SERIAL DEBUGPORT:1 BAUDRATE:115200

### 9. 检验是否正确开启了内核调试模式

重启系统以后，如果 `Windows 7` 的右下角有显示 “`测试模式`”，“`Windows 7`”，“`内部版本 xxxx`” 的字样，就说明开启成功了。

## 二、可能会遇到的问题

### 1. 候补方法

如果以上设置不生效，可以试试下面的方法：

1. 点击 “`开始按钮`”，然后在运行框里输入 `gpedit.msc`，按回车键；

2. 展开：`用户配置` --> `管理模板` --> `系统` --> `驱动程序安装`；

3. 双击右边列表里的 “`设备驱动程序的代码签名`”；

4. 选择 “`已禁用`”，点确定。

### 2. 如果命令行无修改权限

如果遇到提示命令行模式下无修改权限的情况：

1. 在运行框里面输入 “`gpedit.msc`”，进入 “`组策略编辑器`”；

2. 展开：`Windows 设置` --> `安全设置` --> `打开本地策略` --> `安全选项` --> `用户帐户控制`

3. 点击 “`用于内置管理员账户的管理员批准模式`”；

4. 选中 “`已启用`”，保存退出。

### 3. 如果 bcdedit /set 命令提示无修改权限

如果遇到 `bcdedit /set` 命令无修改权限的情况，先尝试使用管理员账号登陆，或者把 `Windows 7` 的 `UAC` 关掉或调到最低。
如果还是解决不了，可以试试上面的 “`如果命令行无修改权限`” 的方法，这个问题我未实践解决过，
以上方法都不行的话，可以 `百度` 或 `Google` 搜索一下出现的错误提示。

<.End.>
